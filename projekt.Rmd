---
title: "SAP Projekt"
author: "StatistiÄki Analizirani"
date: "2025-12-10"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(boot)
library(ggplot2)
```

### Motivacija i opis problema

MoÅ¾dani udar je hitno medicinsko stanje koje nastaje nakon poremeÄ‡aja cirkulacije u mozgu. U Hrvatskoj je drugi najveÄ‡i uzrok smrti te prvi najveÄ‡i uzrok invaliditeta. Rizik od moÅ¾danog udara kod pojedine osobe moÅ¾e ovisiti o viÅ¡e faktora pa se u medicini koriste razni modeli za njegovu procjenu. Nije strana ni uporaba alata zasnovanih na umjernoj inteligenciji. Predikcija moÅ¾danog udara bitna je za pravovremenu identifikaciju rizika koje omoguÄ‡ava pravovremene mjere prevencije i osvjeÅ¡tavanje populacije.

### Opis skupa podataka

Prikupljeni skup podataka sadrÅ¾i kliniÄke podatke o pacijentima i informacije o moÅ¾danom udaru. Za svakog pacijenta navedena je vrijednost 12 znaÄajki grupiranih u 4 kategorije: demografski podaci, zdravstveni podaci, fizioloÅ¡ki podaci i Å¾ivotne navike. Cilj je uoÄiti povezanost izmjerenih podataka i rizika od moÅ¾danog udara. Skup podataka sadrÅ¾ava 5,110 zapisa o pacijentima od kojih je njih 249 doÅ¾ivjelo moÅ¾dani udar. Udio pacijenata koji su doÅ¾ivjeli moÅ¾dani udar iznosi 4.87%

-   id: jedinstveni identifikator pacijenta
-   gender: spol pacijenta (Male, Female)
-   age: dob pacijenta
-   hypertension: oznaka koja daje informaciju o tome ima li pacijent visoki tlak (0, 1)
-   heart_disease: oznaka koja daje informaciju ima li pacijent neku srÄanu bolest (0, 1)
-   ever_married: odgovara na pitanje je li pacijent ikad bio u braku (No, Yes) work_type: tip zaposlenja (children, Govt_job, Never_worked, Private, Self-employed)
-   Residence_type: tip prebivaliÅ¡ta u kojem Å¾ivi pacijent (Rural, Urban)
-   avg_glucose_lvl: prosjeÄna razina glukoze u krvi (mg/dL)
-   bmi: indeks tjelesne mase koji predstavlja odnos visine i teÅ¾ine pacijenta
-   smoking_status: opis pacijentovog odnosa s puÅ¡enjem cigareta (formerly smoked, never smoked, smokes, Unknown)
-   stroke: oznaka koja daje informaciju je li pacijent doÅ¾ivio moÅ¾dani udar (0, 1)

### UÄitavanje i pregled podataka

```{r}
data <- read.csv("data.csv")
head(data)
```

```{r}
str(data)
```

Iz generiranih prikaza moguÄ‡e je vidjeti neke od vrijednosti koje poprimaju pojedini atributi vezani uz pacijenta, ali i tip podataka koji prikazuju. Primjetljivo je kako se atribut bmi vodi kao niz znakova iako semantiÄki predstavlja decimalni broj. Pri izradi dijagrama i u buduÄ‡im raÄunima potrebno je pripaziti da se bmi ne prikaÅ¾e kao kategoriÄni atribut.

#### Prikaz demografskih podataka

```{r}
par(mfrow = c(1,3))
hist(data$age , main = "Distribucija dobi", xlab = "Dob", col = "lightblue", border = "black")
barplot(table(data$gender), main = "Distribucija spola", xlab = "Spol", col = c("pink","lightblue","black"),border="black")
barplot(table(data$ever_married), main = "Distribucija bracnog statusa", xlab = "Bracni status", col = c("orange","lightblue"),border="black")

```

```{r}
summary(data$age)
prop.table(table(data$gender, useNA = "ifany"))
prop.table(table(data$ever_married, useNA = "ifany"))
```

Distribucija dobi ispitanika blago je zakrivljena u lijevo. ProsjeÄan broj godina pacijenta iznosi 43.23 godine, a njihov raspon je razlika izmeÄ‘u 82 godine i 0.08 godina. Dakle, zastupljene su gotovo sve dobne skupine te nema bitnih odstupanja.

Broj Å¾enskih ispitanih pacijenata je neoÄekivano velik u odnosu na muÅ¡ke ispitanike. Pacijentice zauzimaju Äak 58.6% skupa podataka.

VeÄ‡ina ispitanika je u svom Å¾ivotu bar jednom stupila u brak.

```{r}
boxplot(data$age,
main = "Boxplot (dob)",
ylab = "Dob",
col = "aquamarine",
cex.main = 1.5, cex.lab = 1.2)
```

#### Prikaz zdravstvenih podataka

Kao Å¡to je prethodno navedeno, potrebno je pripremiti atribut bmi.

```{r}

bmi<-data$bmi

bmi[bmi == "N/A"] <- NA
bmi <- as.numeric(bmi)

```

```{r}
par(mfrow = c(1,2))
barplot(table(data$hypertension), main = "Distribucija hipertenzije", xlab = "Hipertenzija", col = c("orange","lightblue"),border="black")
barplot(table(data$heart_disease), main = "Distribucija srcanih bolesti", xlab = "Srcane bolesti", col = c("orange","lightblue"),border="black")

```

```{r}
young_with_hypertension <- data[data$age<=median(data$age),]$hypertension
old_with_hypertension <- data[data$age>=median(data$age),]$hypertension

list(
    overall_mean = mean(data$hypertension),
    young_mean   = mean(young_with_hypertension),
    old_mean     = mean(old_with_hypertension)
  )
```

U skupu podataka 9.7% ispitanika ima hipertenziju, meÄ‘utim ona jako ovisi o dobi ispitanika. Ako uzmemo samo ispitanike starije od medijana skupa, ta brojka postane 17.1%

```{r}
young_with_heart_disease <- data[data$age<=median(data$age),]$heart_disease
old_with_heart_disease <- data[data$age>=median(data$age),]$heart_disease

list(
    overall_mean = mean(data$heart_disease),
    young_mean   = mean(young_with_heart_disease),
    old_mean     = mean(old_with_heart_disease)
  )
```

SliÄan rezultat se dobije i sa srÄanim bolestima, gdje u uzorku srÄanu bolest ima oko 5.4% dok stariji dio uzorka ima 10.4%

```{r}
par(mfrow = c(1,2))
hist(data$avg_glucose_level , main = "Distribucija kolicine glukoze u krvi", xlab = "Kolicina glukoze u krvi [mg/dL]", col = "lavender", border = "black")
hist(bmi , main = "Distribucija indeksa BMI", xlab = "BMI", col = "aquamarine", border = "black")
```

```{r}
summary(data$avg_glucose_level)
summary(bmi)
```

```{r}
par(mfrow = c(1,2))
boxplot(data$avg_glucose_level,
main = "Boxplot (razina glukoze)",
ylab = "Razina glukoze",
col = "aquamarine",
cex.main = 1.5, cex.lab = 1.2)
boxplot(bmi,
main = "Boxplot (bmi)",
ylab = "BMI",
col = "lavender",
cex.main = 1.5, cex.lab = 1.2)

```

Distribucije atributa vezanih uz razinu glukoze u krvi te BMI imaju sliÄnost u tome da postoje strÅ¡eÄ‡e vrijednosti. MeÄ‘utim, razina glukoze krvi je viÅ¡e zakrivljena i to se da oÄitati iz broja strÅ¡eÄ‡ih vrijednosti, ali i pomaka crte medijana u interkvartalnom intervalu.

Nijedna od ove dvije distribucije se ne moÅ¾e smatrati savrÅ¡eno normalnom.

#### Prikaz podataka o Å¾ivotnim navikama

```{r}
barplot(table(data$smoking_status), main = "Distribucija statusa pusenja", xlab = "Status pusenja", col = c("orange","lightblue","yellow","lavender"),border="black")
```

```{r}
prop.table(table(data$smoking_status, useNA = "ifany"))
```

Vidljivo je da za veliki postotak ispitanika, Äak preko 30%, nemamo informaciju o njihovom statusu puÅ¡enja. VaÅ¾no je napomenuti da se izbacivanjem zapisa o pacijentima sa statusom puÅ¡enja "Unknown" zapravo izbacuju gotovo sva djeca iz skupa podataka. Ipak, u skupu pacijenata s "Unknown" statusom puÅ¡enja postoje predstavnici gotovo svih dobnih skupina. SljedeÄ‡i histogram prikazuje distribuciju dobi "Unknown" puÅ¡aÄa.

```{r}
hist(data[data$smoking_status == "Unknown",]$age , main = "Distribucija dobi 'Unknown pusaca'", xlab = "Dob", col = "lightblue", border = "black")
```

```{r}
par(mfrow = c(1,2))
barplot(table(data$work_type), main = "Distribucija tipa zaposlenja", xlab = "Tip zaposlenja", col = c("orange","lightblue","yellow","lavender","aquamarine"),border="black")
barplot(table(data$Residence_type), main = "Distribucija tipa prebivaliÅ¡ta", xlab = "Tip prebivaliÅ¡ta", col = c("orange","lightblue","yellow","lavender"),border="black")
```

```{r}
prop.table(table(data$work_type, useNA = "ifany"))
prop.table(table(data$Residence_type, useNA = "ifany"))
```

VeÄ‡ina pacijenata je zaposlena u privatnom sektoru, dok 0,4% njih nikada nije radilo te se moÅ¾e smatrati kao iznimka.

Raspodjela izmeÄ‘u urbane i ruralne sredine u kojoj Å¾ivi pacijent je gotovo jednolika.

```{r}
mean(data$stroke)
```

U nastavku rada nastojat Ä‡e se pokazati povezanost opisanih atributa s moÅ¾danim udarom. Uz pomoÄ‡ statistiÄkih testova nastojat Ä‡e se zakljuÄiti o tome kako i s kolikom uspjeÅ¡nosti je moguÄ‡e prepoznati rizik od moÅ¾danog udara kod pojedine osobe.

### Postoji li statistiÄki znaÄajna razlika u prosjeÄnoj razini glukoze izmeÄ‘u pacijenata sa i bez moÅ¾danog udara?

Potrebno je odrediti postoji li znaÄajna razlika u prosjeÄnoj razini glukoze izmeÄ‘u pacijenata sa i bez moÅ¾danog udara. ZapoÄnimo s preciznim odreÄ‘ivanjem hipoteza - H0: Ne postoji znaÄajna razlika, odnosno: {mean(glucose_stroke) - mean(glucose_no_stroke) = 0} - H1: Postoji znaÄajna razlika: {mean(glucose_stroke) - mean(glucose_no_stroke) != 0}

ProvoÄ‘enjem definiranog testiranja dobit Ä‡emo bolji uvid u povezanost razine glukoze i moÅ¾danog udara, ali neÄ‡emo moÄ‡i odrediti kauzalnost. Dakle, moguÄ‡e je da ljudi koji imaju viÅ¡u glukozu u krvi imaju i veÄ‡i rizik od moÅ¾danog udara, meÄ‘utim moguÄ‡e je i da ljudi koji su veÄ‡ doÅ¾ivjeli moÅ¾dani udar sada imaju veÄ‡u razinu glukoze u krvi nego prije. Bez obzira na to, korisno je napraviti ovu poveznicu.

```{r}
glucose_stroke <- data[data$stroke == 1, ]$avg_glucose_level
glucose_no_stroke <- data[data$stroke == 0,]$avg_glucose_level
summary(glucose_stroke)
summary(glucose_no_stroke)
```

Relativno velika razlika medijana i aritmetiÄke sredine govori o tome koliko je distribucija koliÄine glukoze zakrivljena. Obe distribucije imaju teÅ¾ak desni rep, a distribucija kod ljudi koji su imali moÅ¾dani udar se moÅ¾e Äak smatrati i bimodalnom. Zbog toga se ne moÅ¾e smatrati normalnom, meÄ‘utim centralni graniÄni teorem omoguÄ‡ava da se za testiranje hipoteza koristi t-test kad su uzorci veliki. Bez obzira na to provest Ä‡e se i neparametarska metoda da kako se usporedili rezultati.

```{r}
hist(glucose_stroke , freq = FALSE, main = "Kolicina glukoze u krvi kod ljudi s mozdanim udarom", xlab = "Kolicina glukoze u krvi [mg/dL]", col = "lavender", border = "black")
curve(dnorm(x, mean(glucose_stroke), sd(glucose_stroke)), add = TRUE, col = "red")

```

```{r}
result <- t.test(avg_glucose_level ~ stroke, data = data, var.equal = FALSE)
result
```

Welchov t-test za dva uzorka s razliÄitim varijancama odbacuje nultu hipotezu da su dvije sredine jednake, odnosno prihvaÄ‡a alternativu gdje su sredine razliÄite. To se moÅ¾e vidjeti iz p-vrijednosti koja je jako blizu nuli. Grupa 0 oznaÄava ljude koji nisu imali moÅ¾dani udar i oni oÄekivano imaju manju prosjeÄnu razinu glukoze u krvi, dok preostala grupa ima gotovo 28 mg/dL viÅ¡e glukoze u krvi. Ta se vrijednost nalazi i u izraÄunatom intervalu pouzdanosti.

Ukratko, odbacuje se nulta hipoteza u korist alternativne hipoteze. Sada Ä‡emo to joÅ¡ jednom provjeriti uz pomoÄ‡ neparametarske metode bootstrap.

```{r}
set.seed(67)

B <- 10000

boot_diff <- numeric(B)

for (i in 1:B) {
  boot_stroke <- sample(glucose_stroke, replace = TRUE)
  boot_no_stroke <- sample(glucose_no_stroke, replace = TRUE)
  boot_diff[i] <- mean(boot_stroke) - mean(boot_no_stroke)
}

# Observed mean difference
obs_diff <- mean(glucose_stroke) - mean(glucose_no_stroke)

# 95% bootstrap confidence interval
ci <- quantile(boot_diff, c(0.025, 0.975))

list(
  observed_mean_difference = obs_diff,
  ci_95 = ci
)

```

Vidljivo je da interval 95%-ne pouzdanosti odgovara onom izraÄunatom u Welchovom testu. Neparametarska metoda bootstrap takoÄ‘er odbacuje nultu hipotezu u korist alternativne. KoriÅ¡tena je zato Å¡to ona ne zahtijeva da skup podataka koji testira bude neke odreÄ‘ene distribucije.

### Postoji li interakcijski uÄinak hipertenzije i srÄanih bolesti na BMI?

U ovom istraÅ¾ivaÄkom pitanju prouÄavamo ovisi li indeks tjelesne mase (BMI) o prisutnosti hipertenzije i srÄanih bolesti te postoji li interakcijski uÄinak ova dva Äimbenika. Dakle, zanima nas utjeÄe li hipertenzija na BMI jednako kod osoba sa i bez srÄanih bolesti ili se taj uÄinak mijenja ovisno o postojanju srÄane bolesti. Za potrebe analize koristimo dvostruku analizu varijance s hipertenzijom i srÄanim bolestima kao Äimbenicima te BMI-jem kao zavisnom varijablom.

## Priprema podataka

Najprije pripremamo podatke. BriÅ¡emo nedostajuÄ‡e vrijednosti BMI-ja, pretvaramo BMI u numeriÄku varijablu te kodiramo hipertenziju i srÄane bolesti kao faktore s dvije razine.

```{r novi dataset}
data2 <- read.csv("data.csv", na.strings = "N/A", stringsAsFactors = FALSE)
```

```{r}
data2$hypertension  <- factor(data2$hypertension, levels = c(0,1), labels = c("no_hypertension","has_hypertension"))
data2$heart_disease <- factor(data2$heart_disease, levels = c(0,1), labels = c("no_heart_disease","has_heart_disease"))


data2$bmi <- as.numeric(data$bmi)


anova_data <- data2[, c("bmi", "hypertension", "heart_disease")]


anova_data <- na.omit(anova_data)


str(anova_data$bmi)
summary(anova_data$bmi)
table(anova_data$hypertension, anova_data$heart_disease)
```

Broj opaÅ¾anja nakon izbacivanja nedostajuÄ‡ih vrijednosti daje nam efektivnu veliÄinu uzorka za ovu analizu.

Ukupno je u analizi sudjelovalo 4909 ispitanika. Raspodjela prema prisutnosti hipertenzije i srÄane bolesti je sljedeÄ‡a:

-   nema hipertenziju, nema srÄanu bolest: **87.0 %**
-   nema hipertenziju, ima srÄanu bolest: **3.8 %**
-   ima hipertenziju, nema srÄanu bolest: **8.0 %**
-   ima hipertenziju, ima srÄanu bolest: **1.2 %**

Promatramo li postotke unutar razina hipertenzije:

-   meÄ‘u osobama **bez hipertenzije**:

    -   95.9 % **nema** srÄanu bolest
    -   4.1 % **ima** srÄanu bolest

-   meÄ‘u osobama **s hipertenzijom**:

    -   87.1 % **nema** srÄanu bolest
    -   12.9 % **ima** srÄanu bolest

Promatramo li postotke unutar razina srÄane bolesti:

-   meÄ‘u osobama **bez srÄane bolesti**:

    -   91.6 % **nema** hipertenziju
    -   8.4 % **ima** hipertenziju

-   meÄ‘u osobama **sa srÄanom boleÅ¡Ä‡u**:

    -   76.1 % **nema** hipertenziju
    -   23.9 % **ima** hipertenziju

```{r}
head(anova_data)
```

## Sredine po grupama

Najprije izraÄunavamo prosjeÄne vrijednosti BMI-ja po svakoj kombinaciji hipertenzije i srÄane bolesti te ih vizualiziramo.

```{r}
aggregate(bmi ~ hypertension + heart_disease,
          data = anova_data,
          FUN = mean)
```

```{r boxplot-bmi, message=FALSE, warning=FALSE, fig.width=8, fig.height=5}
ggplot(anova_data,
       aes(x = interaction(hypertension, heart_disease),
           y = bmi,
           fill = heart_disease)) +
  geom_boxplot() +
  labs(x = "Hypertension x heart disease",
       y = "BMI",
       fill = "heart disease",
       title = "BMI distribution for combinations of hypertension and heart diseases") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r interakcijski-graf, fig.width=10, fig.height=8}
with(anova_data,
     interaction.plot(hypertension, heart_disease, bmi,
                      fun = mean,
                      xlab = "Hypertension",
                      ylab = "Average BMI",
                      trace.label = "Heart disease"))
```

Iz tablice sredina i grafova vidimo kako se prosjeÄni BMI razlikuje izmeÄ‘u grupa. Zbog toga nas zanima mijenja li se razlika u BMI-ju izmeÄ‘u osoba s i bez hipertenzije ovisno o tome imaju li srÄanu bolest, Å¡to je indikacija moguÄ‡eg interakcijskog uÄinka.

## Dvostruka ANOVA s interakcijom: formulacija hipoteza i primjena testa

Glavni uÄinak hipertenzije:

-   H0: prosjeÄni BMI je jednak kod osoba sa i bez hipertenzije

-   H1: prosjeÄni BMI se razlikuje izmeÄ‘u osoba sa i bez hipertenzije

Glavni uÄinak srÄanih bolesti:

-   H0: prosjeÄni BMI je jednak kod osoba sa i bez srÄane bolesti

-   H1: prosjeÄni BMI se razlikuje izmeÄ‘u osoba sa i bez srÄane bolesti

Interakcijski uÄinak:

-   H0: nema interakcijskog uÄinka hipertenzije i srÄanih bolesti na BMI

-   H1: postoji interakcijski uÄinak hipertenzije i srÄanih bolesti na BMI

Za testiranje hipoteza koristimo dvostruku ANOVA-u s interakcijom:

```{r}
test_anova <- aov(bmi ~ hypertension * heart_disease, data = anova_data)
summary(test_anova)
```

## Provjera pretpostavki

Analiza varijance pretpostavlja pribliÅ¾nu normalnost reziduala i sliÄnost varijanci izmeÄ‘u grupa.

```{r}
rezid <- residuals(test_anova)

par(mfrow = c(1, 2))
hist(rezid, main = "Residual histogram", xlab = "Residual", col = "lightblue", border = "black")
qqnorm(rezid, main = "QQ residual graf")
qqline(rezid, col = "red")
par(mfrow = c(1, 1))
```

Reziduali pokazuju odreÄ‘ena odstupanja, no zbog velikog uzorka ANOVA je relativno robusna na takva odstupanja.

## Rezultati i interpretacija

Na temelju ANOVA tablice zakljuÄujemo sljedeÄ‡e:

-   Glavni uÄinak hipertenzije na BMI je statistiÄki znaÄajan (F vrijednost je vrlo velika, p \< 0.001), zbog Äega moÅ¾emo zakljuÄiti da osobe s hipertenzijom u prosjeku imaju viÅ¡i BMI od osoba bez hipertenzije.

-   Glavni uÄinak srÄanih bolesti na BMI nije statistiÄki znaÄajan (p-vrijednost je veÄ‡a od 0.05), pa na ovoj razini znaÄajnosti zakluÄujemo da prosjeÄni BMI razlikuje izmeÄ‘u osoba sa i bez srÄane bolesti kada se ostali Äimbenici ne uzimaju u obzir.

-   Interakcijski uÄinak hipertenzije i srÄanih bolesti na BMI je statistiÄki znaÄajan (p \< 0.01), zbog Äega zakljuÄujemo da se uÄinak hipertenzije na BMI razlikuje ovisno o tome ima li osoba srÄanu bolest.

Iz tablice prosjeÄnih BMI vrijednosti po grupama vidimo da je najviÅ¡i BMI tipiÄno prisutan kod osoba koje imaju i hipertenziju i srÄanu bolest, dok je najniÅ¾i BMI kod osoba koje nemaju ni hipertenziju ni srÄanu bolest.

## MoÅ¾emo li predvidjeti vjerojatnost moÅ¾danog udara iz dobi, glukoze, BMI-ja i hipertenzije?

U ovom istraÅ¾ivaÄkom pitanju Å¾elimo ispitati moÅ¾emo li na temelju dobi (age), prosjeÄne razine glukoze u krvi (avg_glucose_level), indeksa tjelesne mase (BMI) i prisutnosti hipertenzije (hypertension) predvidjeti vjerojatnost da je pacijent doÅ¾ivio moÅ¾dani udar (stroke).

PoÅ¡to uzmimamo moÅ¾dani kao binarnu varijablu (0 = nema moÅ¾danog udara, 1 = imao moÅ¾dani udar), koristimo logistiÄku regresiju kao provjeru i test za ovo pitanje. LogistiÄki model nam daje procjenu:

#### ğ‘ƒ ( moÅ¾dani = 1 \| age , glucose , BMI , hypertension )

odnosno ovo predstavlja samu vjerojatnost da pacijent ima moÅ¾dani udar.

Za model uzimamo samo potrebne varijable te izbacujemo retke s nedostajuÄ‡im vrijednostima kako bi model radio bez problema:

```{r}
model_data <- data[, c("stroke", "age", "avg_glucose_level", "bmi", "hypertension")]

# nedostajuÄ‡e BMI vrijednosti -> NA

model_data$bmi[model_data$bmi == "N/A"] <- NA

# pretvaranje BMI u numeriÄku varijablu

model_data$bmi <- as.numeric(model_data$bmi)

# izbacujemo redove s NA

model_data <- na.omit(model_data)

# faktorizacija radi preglednosti

model_data$stroke <- factor(model_data$stroke, levels = c(0, 1),
labels = c("no_stroke", "stroke"))
model_data$hypertension <- factor(model_data$hypertension, levels = c(0, 1),
labels = c("no_hypertension", "has_hypertension"))

nrow(model_data)
table(model_data$stroke)

```

Od ukupno 5110 pacijenata, **4909** opaÅ¾anja ima sve potrebne podatke za model (dob, glukoza, BMI, hipertenzija i ishod moÅ¾danog udara).\
Od tih 4909 pacijenata, 209 je doÅ¾ivjelo moÅ¾dani udar, a 4700 nije â€“ dakle skup je **jako neuravnoteÅ¾en**, Å¡to je tipiÄno za rijetke dogaÄ‘aje.

Kratka usporedba distribucija prediktora po ishodu:

```{r}
# Boxplotovi prediktora po ishodu moÅ¾danog udara

par(mfrow = c(1, 3))
boxplot(age ~ stroke, data = model_data,
main = "Dob po ishodu",
xlab = "Ishod", ylab = "Dob",
col = c("lightblue","orange"))

boxplot(avg_glucose_level ~ stroke, data = model_data,
main = "Glukoza po ishodu",
xlab = "Ishod", ylab = "Prosj. glukoza [mg/dL]",
col = c("lightblue","orange"))

boxplot(bmi ~ stroke, data = model_data,
main = "BMI po ishodu",
xlab = "Ishod", ylab = "BMI",
col = c("lightblue","orange"))

par(mfrow = c(1,1))


```

Iz ovih grafova se veÄ‡ moÅ¾e naslutiti da su **osobe sa moÅ¾danim udarom u prosjeku starije** i imaju **viÅ¡u razinu glukoze**, dok se BMI Äini manje izrazito razliÄitim.

### Izgradnja logistiÄkog modela

LogistiÄka regresija:

```{r}
logreg_model <- glm(stroke ~ age + avg_glucose_level + bmi + hypertension,
data = model_data,
family = binomial)

summary(logreg_model)

```

Na temelju saÅ¾etka modela:

-   **Godine (age)-** koeficijent je pozitivan i visoko statistiÄki znaÄajan (**p \< 0.001**). Stariji pacijenti imaju **veÄ‡i rizik moÅ¾danog udara**.

-   **ProsjeÄna razina glukoze u krvi (avg_glucose_level)-** pozitivan i statistiÄki znaÄajan koeficijent (**p \< 0.001**). ViÅ¡a razina glukoze u krvi je povezana s **poveÄ‡anim rizikom moÅ¾danog udara**.

-   **Hipertenzija (hypertension)-** pozitivan i statistiÄki znaÄajan koeficijent (p â‰ˆ 0.002). Pacijenti s hipertenzijom imaju **viÅ¡i rizik moÅ¾danog udara** u odnosu na one bez hipertenzije, Äak i nakon kontrole za dob, glukozu i BMI.

-   **BMI-** koeficijent je vrlo blizu nule i **nije statistiÄki znaÄajan** (p â‰ˆ 0.82). U prisutnosti dobi, glukoze i hipertenzije, BMI **ne doprinosi dodatno** objaÅ¡njenju rizika moÅ¾danog udara.

### Omjeri izgleda (odds ratio) i interpretacija

Za lakÅ¡u interpretaciju izraÄunavamo **odds ratio (OR)** i njihove 95%-ne intervale pouzdanosti:

```{r}
or_table <- exp(cbind(OddsRatio = coef(logreg_model),
confint(logreg_model)))
or_table

```

TipiÄno dobijemo rezultate sliÄne sljedeÄ‡em obrascu:

-   **Dob**\
    OR â‰ˆ **1.07** (CI otprilike 1.06â€“1.08): Svako poveÄ‡anje dobi za 1 godinu poveÄ‡ava Å¡anse moÅ¾danog udara za oko **7 %**, uz ostale varijable fiksirane.

-   **ProsjeÄna razina glukoze u krvi**\
    OR â‰ˆ **1.005** po 1 mg/dL: Na razini pojedinaÄnih mg/dL uÄinak je malen, ali na razini razlike od npr. 50 mg/dL to se pretvara u razliku od oko 25â€“30 %.

-   **Hipertenzija**\
    OR â‰ˆ **1.7** (CI otprilike 1.2â€“2.4): Osobe s hipertenzijom imaju otprilike **70 % veÄ‡e izglede** (odds) za moÅ¾dani udar u odnosu na osobe bez hipertenzije, pod kontrolom dobi, glukoze i BMI-ja.

-   **BMI**\
    OR â‰ˆ **1.00**, uz interval pouzdanosti koji obuhvaÄ‡a 1: Nema uvjerljivog dokaza da BMI samostalno mijenja rizik od moÅ¾danog udara nakon Å¡to se u model ukljuÄe dob, glukoza i hipertenzija.

### Predikcija vjerojatnosti i problem praga 0.5

Model za svakog pacijenta vraÄ‡a procijenjenu vjerojatnost moÅ¾danog udara:

```{r}
model_data$prob <- predict(logreg_model, type = "response")
summary(model_data$prob)

```

Standardno pravilo u logistiÄkoj regresiji kaÅ¾e:

-   Ako je vjerojatnost \>= 0.5 â†’ klasificiramo kao **stroke**

-   InaÄe = **no_stroke**

MeÄ‘utim, buduÄ‡i da je moÅ¾dani udar rijedak dogaÄ‘aj (oko 4â€“5 %), **model gotovo nikome neÄ‡e dodijeliti vjerojatnost â‰¥ 0.5**. To znaÄi da bi, s pragom 0.5, **svi bili predviÄ‘eni kao â€œno_strokeâ€**, Å¡to nije korisno.

Distribuciju predikcija po ishodu moÅ¾emo pogledati ovako:\

```{r}
ggplot(model_data, aes(x = prob, fill = stroke)) +
geom_histogram(alpha = 0.6, position = "identity", bins = 40) +
labs(title = "Distribucija predviÄ‘enih vjerojatnosti moÅ¾danog udara",
x = "PredviÄ‘ena vjerojatnost moÅ¾danog udara",
y = "Broj pacijenata",
fill = "Stvarni ishod") +
theme_minimal()

```

VeÄ‡ina predikcija leÅ¾i ispod 0.1, Å¡to je oÄekivano za rijedak dogaÄ‘aj.

### ROC krivulja i AUC â€“ kvaliteta modela

Umjesto da koristimo jedan fiksni prag (npr. 0.5), za evaluaciju modela koristimo **ROC krivulju** i **AUC**.

-   **ROC krivulja** prikazuje omjer **osjetljivosti (sensitivnost)** i **1 âˆ’ specifiÄnost** za sve moguÄ‡e pragove vjerojatnosti.
-   **AUC** (Area Under the Curve) mjeri ukupnu sposobnost modela da razlikuje pacijente s moÅ¾danim udarom od onih bez.
    -   AUC = 0.5 â†’ model nije bolji od sluÄajnog pogaÄ‘anja

    -   AUC = 1 â†’ savrÅ¡en model

    -   U praksi: 0.7â€“0.8 â€œpristojnoâ€, 0.8â€“0.9 â€œdobroâ€.

```{r}
# za ROC koristimo paket pROC

library(pROC)

roc_obj <- roc(response = model_data$stroke,
predictor = model_data$prob,
levels = c("no_stroke", "stroke"))  # redoslijed: kontrola, sluÄaj

auc(roc_obj)

plot(roc_obj, col = "blue", lwd = 2,
main = "ROC krivulja logistiÄkog modela")
abline(a = 0, b = 1, lty = 2, col = "grey")

```

U naÅ¡em sluÄaju AUC je pribliÅ¾no **0.85**, Å¡to znaÄi da model **vrlo dobro razlikuje** pacijente koji su doÅ¾ivjeli moÅ¾dani udar od onih koji nisu.

Primjer â€œoptimalnogâ€ praga (npr. prema Youdenovom indeksu):

```{r}
coords(roc_obj, "best",
ret = c("threshold", "sensitivity", "specificity"))

```

TipiÄno dobijemo prag oko 0.04, uz:

-   **osjetljivost** â‰ˆ 0.85 (model ispravno â€œuhvatiâ€ oko 85 % moÅ¾danih udara

-   **specifiÄnost** â‰ˆ 0.71 (oko 71 % osoba bez moÅ¾danog se ispravno predvidi kao â€œno_strokeâ€)

Dakle, ako spustimo prag dovoljno nisko, model moÅ¾e biti **osjetljiv** (dobar u hvatanju riziÄnih pacijenata), iako uz odreÄ‘eni broj laÅ¾no pozitivnih.

### Vizualizacija uÄinka dobi i hipertenzije na rizik

Da bismo intuitivno prikazali kako se procijenjena vjerojatnost moÅ¾danog udara mijenja s dobi i hipertenzijom, promatramo predikcije za:

-   razliÄitu dob,

-   fiksnu prosjeÄnu glukozu i BMI (medijan),

-   odvojeno po hipertenziji (da / ne).

```{r}
# grid za dob i hipertenziju

age_grid <- seq(min(model_data$age), max(model_data$age), length.out = 100)

new_age_data <- expand.grid(
age = age_grid,
hypertension = levels(model_data$hypertension)
)

new_age_data$avg_glucose_level <- median(model_data$avg_glucose_level, na.rm = TRUE)
new_age_data$bmi                <- median(model_data$bmi, na.rm = TRUE)

new_age_data$pred_prob <- predict(logreg_model,
newdata = new_age_data,
type = "response")

ggplot(new_age_data,
aes(x = age, y = pred_prob, color = hypertension)) +
geom_line(size = 1.1) +
labs(title = "PredviÄ‘ena vjerojatnost moÅ¾danog udara po dobi",
subtitle = "Za medijan glukoze i BMI-ja",
x = "Dob",
y = "PredviÄ‘ena vjerojatnost moÅ¾danog udara",
color = "Hipertenzija") +
theme_minimal()

```

Iz grafa se vidi:

-   rizik moÅ¾danog udara **raste s dobi**,

-   za **svaku dob** krivulja za `has_hypertension` leÅ¾i iznad krivulje za `no_hypertension`,\
    Å¡to potvrÄ‘uje da hipertenzija poveÄ‡ava rizik, neovisno o dobi

### Vizualizacija uÄinka glukoze

SliÄno moÅ¾emo pogledati kako razina glukoze utjeÄe na rizik, za â€œtipiÄnogâ€ pacijenta (srednja dob, srednji BMI):

```{r}
glucose_grid <- seq(
quantile(model_data$avg_glucose_level, 0.01),
quantile(model_data$avg_glucose_level, 0.99),
length.out = 100
)

new_gluc_data <- expand.grid(
avg_glucose_level = glucose_grid,
hypertension = levels(model_data$hypertension)
)

new_gluc_data$age <- median(model_data$age, na.rm = TRUE)
new_gluc_data$bmi <- median(model_data$bmi, na.rm = TRUE)

new_gluc_data$pred_prob <- predict(logreg_model,
newdata = new_gluc_data,
type = "response")

ggplot(new_gluc_data,
aes(x = avg_glucose_level, y = pred_prob, color = hypertension)) +
geom_line(size = 1.1) +
labs(title = "PredviÄ‘ena vjerojatnost moÅ¾danog udara po glukozi",
subtitle = "Za medijan dobi i BMI-ja",
x = "ProsjeÄna razina glukoze [mg/dL]",
y = "PredviÄ‘ena vjerojatnost moÅ¾danog udara",
color = "Hipertenzija") +
theme_minimal()

```

Ovdje vidimo da:

-   viÅ¡a glukoza **poveÄ‡ava vjerojatnost moÅ¾danog udara**,

-   ponovno, osobe s hipertenzijom imaju viÅ¡i rizik za sve razine glukoze

### **Rezultati**

-   U model je ukljuÄeno **4909 pacijenata**, od Äega je oko **5 %** imalo moÅ¾dani udar.

-   StatistiÄki znaÄajni prediktori su:

    -   **dob** (stariji pacijenti imaju veÄ‡i rizik),

    -   **prosjeÄna razina glukoze** (viÅ¡e vrijednosti â†’ veÄ‡i rizik),

    -   **hipertenzija** (poveÄ‡ava rizik u odnosu na osobe bez hipertenzije).

-   **BMI nije znaÄajan** prediktor kada su ostale varijable ukljuÄene u model.

-   Omjeri izgleda pokazuju:

    -   poveÄ‡anje dobi za 1 godinu poveÄ‡ava izglede za moÅ¾dani udar,

    -   viÅ¡e glukoze poveÄ‡ava rizik,

    -   hipertenzija poveÄ‡ava izglede za moÅ¾dani udar za oko 1.5â€“2 puta.

-   BuduÄ‡i da je moÅ¾dani udar rijedak dogaÄ‘aj, veÄ‡ina predviÄ‘enih vjerojatnosti je **manja od 0.1**, pa prag 0.5 nije koristan za klasifikaciju.

-   ROC analiza daje **AUC â‰ˆ 0.85**, Å¡to znaÄi da model **dobro razlikuje** pacijente s moÅ¾danim udarom od onih bez njega.

-   Dijagrami pokazuju da:

    -   rizik raste s dobi i glukozom,

    -   hipertenzija dodatno poveÄ‡ava rizik,

    -   BMI ne mijenja procijenjenu vjerojatnost na vidljiv naÄin.

### ZakljuÄak

Dobiveni rezultati pokazuju da **dob**, **prosjeÄna razina glukoze u krvi** i **hipertenzija** Äine **znaÄajne i kliniÄki opravdane prediktore** rizika od moÅ¾danog udara u promatranom skupu podataka. Model logistiÄke regresije na temelju ta tri faktora postiÅ¾e **dobru diskriminacijsku moÄ‡** (AUC â‰ˆ 0.85) i moÅ¾e dobro razlikovati riziÄne od neriziÄnih pacijenata.

S druge strane, **BMI se u ovom modelu ne pokazuje statistiÄki znaÄajnim prediktorom**, Å¡to znaÄi da nakon Å¡to uzmemo u obzir dob, glukozu i hipertenziju, indeks tjelesne mase ne doprinosi dodatnoj informaciji o riziku moÅ¾danog udara. To ne znaÄi da BMI nije vaÅ¾an zdravstveni pokazatelj opÄ‡enito, nego da u ovoj konkretnoj kombinaciji varijabli i uzorka nema samostalan efekt na ishod.

VaÅ¾no je naglasiti i da je moÅ¾dani udar **rijedak dogaÄ‘aj**, pa se model ne smije procjenjivati samo prema standardnom pragu 0.5. Primjerenije je koristiti niÅ¾e pragove, odabrane na temelju ROC krivulje i kliniÄkih prioriteta (npr. favoriziranje veÄ‡e osjetljivosti kako bismo â€œuhvatiliâ€ Å¡to viÅ¡e riziÄnih pacijenata, uz prihvaÄ‡anje veÄ‡eg broja laÅ¾no pozitivnih).

ZakljuÄno, u naÅ¡em uzorku je **moguÄ‡e predvidjeti vjerojatnost moÅ¾danog udara** uz pomoÄ‡ relativno jednostavnog modela koji koristi dob, glukozu i hipertenziju, dok BMI u prisutnosti ovih varijabli nema znaÄajan doprinos. Ovakav model moÅ¾e posluÅ¾iti kao **koristan alat za procjenu rizika** i inicijalno izdvajanje pacijenata kojima bi trebalo posvetiti dodatnu paÅ¾nju, ali svakako ne zamjenjuje detaljnu kliniÄku procjenu i druge relevantne informacije o zdravstvenom stanju pacijenta.

## Postoji li povezanost izmedu statusa puÅ¡enja i nastanka moÅ¾danog udara?

U analizi se ispituje postoji li povezanost izmeÄ‘u statusa puÅ¡enja i pojave moÅ¾danog udara. Prvo se varijable smoking_status i stroke pretvaraju u faktore kako bi se mogle ispravno koristiti u kontingencijskoj tablici i Chi-kvadrat testu.

Zatim se formira kontingencijska tablica za tri kategorije puÅ¡enja (bez Unknown) kako bi se izbjegla izobliÄenja u rezultatima.

## Postotak moÅ¾danih udara po kategorijama puÅ¡enja

Kako bismo bolje razumjeli uÄestalost moÅ¾danog udara unutar svake skupine puÅ¡aÄkog statusa, izraÄ‘en je barplot koji prikazuje proporciju pacijenata s moÅ¾danim udarom u odnosu na ukupni broj osoba unutar svake kategorije puÅ¡enja.

Iz grafa se moÅ¾e jasno vidjeti u kojoj skupini je udio moÅ¾danih udara najveÄ‡i, Å¡to dodatno nadopunjuje statistiÄki rezultat Chi-kvadrat testa.

```{r}
# Proporcije moÅ¾danih udara unutar svake kategorije puÅ¡enja
# Redovi: status puÅ¡enja, stupci: stroke (0/1)
data$smoking_status <- as.factor(data$smoking_status)
data$stroke <- as.factor(data$stroke)

tablica <- table(data$smoking_status, data$stroke)
tablica <- tablica[-4, ]  # uklanjamo 'Unknown'

prop_tab <- prop.table(tablica, 1)  # row-wise proportions

# Barplot â€“ prikaz proporcija
barplot(t(prop_tab),
        beside = TRUE,                  # stupci jedan do drugog
        legend = TRUE,                  # legenda za stroke 0/1
        col = c("skyblue", "orange"),   # boje za stroke 0 i 1
        main = "Postotak moÅ¾danih udara po kategorijama puÅ¡enja",
        xlab = "Status puÅ¡enja",
        ylab = "Proporcija pacijenata",
        ylim = c(0,1))                  # proporcija od 0 do 1

```

## Chi-kvadrat test â€“ osnovna tablica

U ovom dijelu analiziramo odnos izmeÄ‘u statusa puÅ¡enja i pojave moÅ¾danog udara. Nakon ÄiÅ¡Ä‡enja podataka kreirana je kontingencijska tablica koja ukljuÄuje tri kategorije puÅ¡enja: never smoked, formerly smoked i smokes (kategorija Unknown je uklonjena).

Na temelju ove tablice proveden je Chi-kvadrat test neovisnosti kako bi se provjerilo postoji li statistiÄki znaÄajna povezanost izmeÄ‘u statusa puÅ¡enja i moÅ¾danog udara. Test vraÄ‡a vrijednost statistike, stupnjeve slobode i p-vrijednost. Ako je p-vrijednost manja od 0.05, odbacujemo hipotezu o neovisnosti i zakljuÄujemo da je status puÅ¡enja povezan s pojavom moÅ¾danog udara.

Uz to se pregledavaju i oÄekivane frekvencije kako bismo provjerili jesu li zadovoljeni uvjeti za ispravno provoÄ‘enje Chi-kvadrat testa (svaka oÄekivana frekvencija \> 5). Ovaj test pruÅ¾a osnovni uvid u to razlikuju li se skupine puÅ¡aÄa u uÄestalosti moÅ¾danog udara.

Hipoteze:

-   H0: Status puÅ¡enja nije povezan s pojavom moÅ¾danog udara (neovisne su varijable).

-   H1: Status puÅ¡enja je povezan s pojavom moÅ¾danog udara (varijable nisu neovisne).

```{r}

# ÄŒiÅ¡Ä‡enje: pretvaranje smoking_status u faktor
data$smoking_status <- as.factor(data$smoking_status)
data$stroke <- as.factor(data$stroke)

# Kontingencijska tablica
tablica <- table(data$smoking_status, data$stroke)
tablica <- tablica[-4, ]
tablica

# Chi-square test
chi_rezultat <- chisq.test(tablica)
chi_rezultat


chi_rezultat$expected
```

U nastavku je prikazan barplot koji vizualno predstavlja povezanost izmeÄ‘u statusa puÅ¡enja i pojave moÅ¾danog udara. Svaka skupina puÅ¡aÄkog statusa (never smoked, formerly smoked, smokes) prikazana je s pripadnim brojem osoba koje su doÅ¾ivjele ili nisu doÅ¾ivjele moÅ¾dani udar.

```{r}
# Barplot â€“ odnos puÅ¡enja i moÅ¾danog udara (osnovna tablica)
barplot(tablica,
        beside = TRUE,
        legend = TRUE,
        col = c("skyblue", "orange", "lightgreen"),
        main = "Povezanost puÅ¡enja i moÅ¾danog udara",
        xlab = "Status puÅ¡enja",
        ylab = "Broj pacijenata")
```

Kontingencijska tablica ukljuÄivala je tri kategorije puÅ¡enja: never smoked, formerly smoked i smokes. Chi-kvadrat test neovisnosti pokazao je p-vrijednost manju od 0.05, Å¡to znaÄi da postoji statistiÄki znaÄajna povezanost izmeÄ‘u statusa puÅ¡enja i moÅ¾danog udara. OÄekivane frekvencije su bile zadovoljavajuÄ‡e (\>5), Å¡to potvrÄ‘uje valjanost testa.

## Spajanje kategorija â€“ bivÅ¡i i sadaÅ¡nji puÅ¡aÄi vs. nikad puÅ¡ili

U drugom pristupu spajaju se kategorije formerly smoked i smokes u jednu zajedniÄku skupinu nazvanu â€was smoking/smokesâ€œ. Time se formiraju dvije jasne skupine:

1.  Osobe koje nikada nisu puÅ¡ile (never smoked)

2.  Osobe koje su puÅ¡ile, bez obzira na to puÅ¡e li trenutno ili su prestale (was smoking/smokes)

Ovakva podjela omoguÄ‡uje ispitivanje temeljnog pitanja: Je li bilo kakva povijest puÅ¡enja povezana s pojavom moÅ¾danog udara?

Nakon formiranja nove tablice provodi se Chi-kvadrat test neovisnosti kako bi se provjerilo razlikuje li se uÄestalost moÅ¾danog udara izmeÄ‘u ove dvije skupine. Ako je dobivena p-vrijednost statistiÄki znaÄajna (p \< 0.05), zakljuÄujemo da postoji povezanost izmeÄ‘u povijesti puÅ¡enja i rizika moÅ¾danog udara.

Uz test izraÄ‘en je i barplot koji grafiÄki prikazuje raspodjelu moÅ¾danog udara u dvjema skupinama. Vizualizacija dodatno olakÅ¡ava uoÄavanje eventualnih razlika izmeÄ‘u osoba koje nikad nisu puÅ¡ile i onih koje su puÅ¡ile barem jednom u Å¾ivotu.

Hipoteze:

-   H0: Povijest puÅ¡enja (nikad vs. ikad) nije povezana s pojavom moÅ¾danog udara.

-   H1: Povijest puÅ¡enja (nikad vs. ikad) jest povezana s pojavom moÅ¾danog udara.

```{r}

# Kreiranje nove tablice: spajamo kategorije 'formerly smoked' i 'smokes'
nova_tablica <- table(data$smoking_status, data$stroke)

# Uklanjamo kategoriju 'Unknown' jer nema korisne informacije
nova_tablica <- nova_tablica[-4, ]

# Spajamo redove: formerly smoked + smokes
# (to znaÄi da gledamo osobe koje su ikada puÅ¡ile â€“ trenutno ili ranije)
nova_tablica[2,] <- nova_tablica[2, ] + nova_tablica[3, ]

# BriÅ¡emo sada veÄ‡ spojen treÄ‡i red
nova_tablica <- nova_tablica[-3, ]

# Preimenujemo redove radi jasnijeg prikaza
rownames(nova_tablica)[1] <- "never smoked"        # nikad nisu puÅ¡ili
rownames(nova_tablica)[2] <- "was smoking/smokes"  # ikad puÅ¡ili (prije ili sada)

# Prikaz nove tablice nakon spajanja
nova_tablica

# Chi-kvadrat test za provjeru povezanosti izmeÄ‘u puÅ¡enja (nikad vs. ikad) i moÅ¾danog udara
# Ako je p-vrijednost < 0.05 â†’ postoji statistiÄka povezanost izmeÄ‘u puÅ¡enja i moÅ¾danog udara
chi_rezultat <- chisq.test(nova_tablica)

# Ispis rezultata testa
chi_rezultat

chi_rezultat$expected

```

```{r}
barplot(nova_tablica,
        beside = TRUE,                 
        legend = TRUE,                 
        col = c("orange", "lightgreen"),
        main = "MoÅ¾dani udar prema povijesti puÅ¡enja",
        xlab = "Status puÅ¡enja",
        ylab = "Broj pacijenata")
```

Kombinirane su kategorije formerly smoked i smokes u jednu skupinu â€was smoking/smokesâ€œ, a druga skupina su osobe koje nikada nisu puÅ¡ile. Chi-kvadrat test na ovoj dvodijelnoj tablici takoÄ‘er je dao p-vrijednost manju od 0.05, Å¡to potvrÄ‘uje statistiÄki znaÄajnu razliku u uÄestalosti moÅ¾danog udara izmeÄ‘u osoba koje nikada nisu puÅ¡ile i onih koje su ikada puÅ¡ile (trenutno ili prije).
